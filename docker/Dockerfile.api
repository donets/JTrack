FROM node:20-alpine

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@9.12.0 --activate

COPY . .

RUN pnpm install --frozen-lockfile
RUN pnpm --filter @jtrack/shared build
RUN pnpm --filter @jtrack/api prisma:generate
RUN pnpm --filter @jtrack/api build

EXPOSE 3001

CMD ["sh", "-c", "pnpm --filter @jtrack/api prisma:deploy && pnpm --filter @jtrack/api start"]

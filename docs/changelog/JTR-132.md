# JTR-132

- Date: 2026-03-02
- Scope: add sequential human-readable ticket numbers across API, sync, and UI surfaces

## What changed

- Added `ticketNumber` to the Prisma `Ticket` model with a location-scoped unique constraint.
- Added migration `20260302093000_ticket_number`:
  - adds `Ticket.ticketNumber`,
  - backfills existing records with `ROW_NUMBER() OVER (PARTITION BY locationId ORDER BY createdAt, id)`,
  - enforces `NOT NULL` and unique index on `("locationId", "ticketNumber")`.
- Updated ticket creation logic in `TicketsService` to assign the next per-location ticket number.
- Updated sync upsert logic to preserve incoming `ticketNumber` or assign next per-location value when absent.
- Updated shared ticket schema with `ticketNumber` support and propagated the field to frontend storage/mappings.
- Updated ticket number display in key UI surfaces:
  - tickets table title cell,
  - ticket detail page header,
  - kanban/disptach ticket cards,
  - dashboard and dispatch map ticket labels.
- Updated seed data to include deterministic `ticketNumber` values.

## Docs updated

- `docs/api-spec.yml`
- `docs/data-models.ts`
- `docs/db-schema.sql`
- `docs/architecture.md`
- `docs/system-design.md`
- `docs/plans/ui-ux-plan.md`

## Files

- `apps/api/prisma/schema.prisma`
- `apps/api/prisma/migrations/20260302093000_ticket_number/migration.sql`
- `apps/api/prisma/seed.ts`
- `apps/api/src/tickets/tickets.service.ts`
- `apps/api/src/tickets/tickets.service.spec.ts`
- `apps/api/src/sync/sync.service.ts`
- `packages/shared/src/schemas.ts`
- `apps/web/plugins/rxdb.client.ts`
- `apps/web/composables/useOfflineRepository.ts`
- `apps/web/composables/useDispatchBoard.ts`
- `apps/web/composables/useDashboardStats.ts`
- `apps/web/types/ui.ts`
- `apps/web/utils/format.ts`
- `apps/web/utils/ticketVisuals.ts`
- `apps/web/pages/tickets/index.vue`
- `apps/web/pages/tickets/[id].vue`
- `apps/web/pages/dispatch.vue`
- `apps/web/components/domain/TicketKanbanCard.vue`
- `apps/web/components/dispatch/DispatchMapView.vue`
- `docs/changelog/JTR-132.md`

## Verification

- `pnpm --filter @jtrack/shared build`
- `pnpm --filter @jtrack/api prisma:generate`
- `pnpm --filter @jtrack/api typecheck`
- `pnpm --filter @jtrack/web typecheck`
- `pnpm --filter @jtrack/api test -- src/tickets/tickets.service.spec.ts`

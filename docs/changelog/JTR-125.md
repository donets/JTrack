# JTR-125

- Date: 2026-03-02
- Scope: add `TicketActivity` entity, timeline API endpoint, and sync/RxDB plumbing

## What changed

- Added Prisma enum/model:
  - `TicketActivityType`
  - `TicketActivity` with links to `Ticket`, `Location`, and optional actor `User`.
- Added migration `20260302100000_ticket_activities` with indexes for:
  - sync windows (`locationId`, `updatedAt`),
  - timeline fetches (`ticketId`, `createdAt`).
- Added timeline endpoint `GET /tickets/{id}/activity` in tickets module.
- Added activity recording for key mutations:
  - ticket creation,
  - status changes,
  - assignment changes,
  - comment creation,
  - attachment metadata creation,
  - payment creation.
- Extended sync contracts and backend/web sync implementations with:
  - `changes.ticketActivities`,
  - `cursor.ticketActivitiesOffset`.
- Added RxDB `ticketActivities` collection and wired location cleanup + sync apply flow.
- Updated shared schemas/types for `TicketActivity` and sync cursor/changes.

## Docs updated

- `docs/api-spec.yml`
- `docs/data-models.ts`
- `docs/db-schema.sql`
- `docs/architecture.md`
- `docs/system-design.md`
- `docs/plans/ui-ux-plan.md`

## Files

- `apps/api/prisma/schema.prisma`
- `apps/api/prisma/migrations/20260302100000_ticket_activities/migration.sql`
- `apps/api/src/tickets/tickets.controller.ts`
- `apps/api/src/tickets/tickets.service.ts`
- `apps/api/src/tickets/tickets.service.spec.ts`
- `apps/api/src/comments/comments.service.ts`
- `apps/api/src/attachments/attachments.service.ts`
- `apps/api/src/payments/payments.controller.ts`
- `apps/api/src/payments/payments.service.ts`
- `apps/api/src/sync/sync.service.ts`
- `apps/api/src/sync/sync.service.spec.ts`
- `packages/shared/src/schemas.ts`
- `packages/shared/src/sync.ts`
- `packages/shared/src/sync.spec.ts`
- `apps/web/plugins/rxdb.client.ts`
- `apps/web/stores/sync.ts`
- `apps/web/stores/sync.spec.ts`
- `apps/web/stores/location.ts`
- `apps/web/stores/location.spec.ts`
- `docs/changelog/JTR-125.md`

## Verification

- `pnpm --filter @jtrack/shared build`
- `pnpm --filter @jtrack/api prisma:generate`
- `pnpm --filter @jtrack/shared test -- src/sync.spec.ts`
- `pnpm --filter @jtrack/api test -- src/sync/sync.service.spec.ts src/tickets/tickets.service.spec.ts`
- `pnpm --filter @jtrack/web test -- stores/sync.spec.ts stores/location.spec.ts`
- `pnpm --filter @jtrack/api typecheck`
- `pnpm --filter @jtrack/web typecheck`

## Review follow-up (2026-03-02)

- Hardened sync push contract: server now ignores client-sent `changes.ticketActivities` payload.
- `TicketActivity` remains server-authored audit trail only (created by backend domain actions).
- Added sync service regression test ensuring `ticketActivity.create/update` are not called from push payload.

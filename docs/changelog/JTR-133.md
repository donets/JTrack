# JTR-133

- Date: 2026-03-02
- Scope: enforce role-based ticket status transitions on API and align UI transition list with shared policy

## What changed

- Added shared transition policy module:
  - `validateStatusTransition(current, next, role, options?)`
  - `listAllowedStatusTransitions(current, role, options?)`
- Implemented server-side status transition validation in `TicketsService.transitionStatus()`:
  - loads current status,
  - validates requested transition against shared policy,
  - returns `422 Unprocessable Entity` with descriptive message on invalid transition.
- Added new `CurrentLocationRole` decorator to read role resolved by `LocationGuard`.
- Updated tickets controller to pass location role into transition service.
- Updated ticket detail UI to consume shared `listAllowedStatusTransitions()` so client dropdown is consistent with server rules.
- Added coverage:
  - shared transition policy unit tests,
  - API service tests for valid/invalid transitions.

## Docs updated

- `docs/api-spec.yml` (`/tickets/{id}/status` now documents `422`)
- `docs/architecture.md`
- `docs/system-design.md`
- `docs/plans/ui-ux-plan.md`

## Files

- `packages/shared/src/ticket-status-transitions.ts`
- `packages/shared/src/ticket-status-transitions.spec.ts`
- `packages/shared/src/index.ts`
- `apps/api/src/common/current-location-role.decorator.ts`
- `apps/api/src/tickets/tickets.controller.ts`
- `apps/api/src/tickets/tickets.service.ts`
- `apps/api/src/tickets/tickets.service.spec.ts`
- `apps/web/pages/tickets/[id].vue`
- `docs/api-spec.yml`
- `docs/architecture.md`
- `docs/system-design.md`
- `docs/plans/ui-ux-plan.md`
- `docs/changelog/JTR-133.md`

## Verification

- `pnpm --filter @jtrack/shared test -- src/ticket-status-transitions.spec.ts`
- `pnpm --filter @jtrack/api test -- src/tickets/tickets.service.spec.ts`
- `pnpm --filter @jtrack/api typecheck`
- `pnpm --filter @jtrack/web typecheck`
